- name: Deploy Java Application with Docker
  hosts: server_prod
  become: yes
  vars:
    nexus_url: "https://proanarchy-easton-stertorously.ngrok-free.dev"
    artifact_path: "repository/maven-snapshots/sn/mouhammad/isi/candidats/1.0-SNAPSHOT/candidats-1.0-SNAPSHOT.jar"
    app_dest: "/opt/app"

  tasks:
    - name: Ensure SSH host key is accepted
      command: ssh-keyscan -H {{ ansible_host | default(inventory_hostname) }} >> ~/.ssh/known_hosts
      delegate_to: localhost
      become: no
      run_once: yes

    - name: Install dependencies
      apt:
        name: [python3-docker, ca-certificates]
        state: present
        update_cache: yes

    - name: Ensure destination directory exists
      file:
        path: "{{ app_dest }}"
        state: directory
        mode: '0755'

    - name: Pull latest artifact from Nexus
      get_url:
        url: "{{ nexus_url }}/{{ artifact_path }}"
        dest: "{{ app_dest }}/app.jar"
        force: yes
        url_username: "admin"
        url_password: "pass123"
        validate_certs: no  # Important si ngrok utilise un certificat auto-sign√©

    - name: Remove existing container
      docker_container:
        name: java_app
        state: absent

    - name: Start application container
      docker_container:
        name: java_app
        image: eclipse-temurin:17-jre-alpine
        state: started
        restart_policy: always
        published_ports:
          - "8080:8080"
        volumes:
          - "{{ app_dest }}/app.jar:/app/app.jar"
        working_dir: /app
        command: java -jar app.jar