- name: Deploy Java Application with Docker
  hosts: server_prod
  become: yes
  vars:
    nexus_url: "https://proanarchy-easton-stertorously.ngrok-free.dev"
    # Chemin direct vers l'artefact pour éviter les erreurs 404 de l'API de recherche
    artifact_path: "repository/maven-snapshots/sn/mouhammad/isi/candidats/1.0-SNAPSHOT/candidats-1.0-SNAPSHOT.jar"
    app_dest: "/opt/app"

  tasks:
    - name: Install python3-docker
      apt:
        name: python3-docker
        state: present
        update_cache: yes

    - name: Ensure destination directory exists
      file:
        path: "{{ app_dest }}"
        state: directory
        mode: '0755'

    - name: Pull latest artifact from Nexus (REST API)
      shell: |
        curl -L -k -u admin:pass123 \
        "{{ nexus_url }}/service/rest/v1/search/assets/download?repository=maven-snapshots&maven.groupId=sn.mouhammad.isi&maven.artifactId=candidats&maven.extension=jar&sort=version" \
        -o "{{ app_dest }}/app.jar"
      register: download_result

    - name: Verify downloaded file
      shell: "file {{ app_dest }}/app.jar"
      register: file_info

    - name: Debug file info
      debug:
        var: file_info.stdout

    - name: Debug download status
      debug:
        msg: "Le fichier a été téléchargé dans {{ app_dest }}/app.jar"

    - name: Remove existing container if it exists
      docker_container:
        name: java_app
        state: absent

    - name: Start application container
      docker_container:
        name: java_app
        image: eclipse-temurin:17-jre-alpine
        state: started
        restart_policy: always
        published_ports:
          - "8080:8080"
        volumes:
          - "{{ app_dest }}/app.jar:/app/app.jar"
        working_dir: /app
        # -Djava.awt.headless=true est crucial pour JavaFX sur un serveur sans écran
        # Cela évite que la JVM cherche une interface graphique inexistante
        command: java -Djava.awt.headless=true -jar app.jar

    - name: Wait for container to stabilize
      pause:
        seconds: 5

    - name: Check container status
      command: docker ps -f name=java_app
      register: docker_status

    - name: Display container status
      debug:
        var: docker_status.stdout_lines